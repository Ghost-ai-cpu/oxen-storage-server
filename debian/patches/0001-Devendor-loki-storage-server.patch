From: Jason Rhinelander <jason@imaginary.ca>
Date: Tue, 16 Jul 2019 16:08:10 -0300
Subject: Devendor loki-storage-server

---
 CMakeLists.txt                  |  1 -
 common/CMakeLists.txt           |  2 +-
 httpserver/CMakeLists.txt       | 17 ++++++-----------
 httpserver/dns_text_records.cpp |  2 +-
 httpserver/http_connection.h    |  2 +-
 httpserver/lmq_server.cpp       |  2 ++
 httpserver/request_handler.h    |  2 +-
 httpserver/stats.cpp            |  2 +-
 storage/CMakeLists.txt          |  4 ++--
 9 files changed, 15 insertions(+), 19 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 24767b3..652dab9 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -37,7 +37,6 @@ loki_add_subdirectory(crypto)
 loki_add_subdirectory(pow)
 loki_add_subdirectory(storage)
 loki_add_subdirectory(httpserver)
-loki_add_subdirectory(vendors/spdlog)
 
 if (BUILD_TESTS)
     loki_add_subdirectory(unit_test)
diff --git a/common/CMakeLists.txt b/common/CMakeLists.txt
index 115ea47..57c7ef9 100644
--- a/common/CMakeLists.txt
+++ b/common/CMakeLists.txt
@@ -15,7 +15,7 @@ find_package(Boost
 set_property(TARGET common PROPERTY CXX_STANDARD 17)
 set_property(TARGET common PROPERTY CXX_STANDARD_REQUIRED TRUE)
 
-loki_add_subdirectory(../vendors/spdlog spdlog)
+find_package(spdlog)
 
 target_link_libraries(common PUBLIC spdlog::spdlog ${Boost_LIBRARIES})
 target_include_directories(common PUBLIC
diff --git a/httpserver/CMakeLists.txt b/httpserver/CMakeLists.txt
index bdff45e..8d8f845 100644
--- a/httpserver/CMakeLists.txt
+++ b/httpserver/CMakeLists.txt
@@ -30,8 +30,6 @@ loki_add_subdirectory(../storage storage)
 loki_add_subdirectory(../utils utils)
 loki_add_subdirectory(../pow pow)
 loki_add_subdirectory(../crypto crypto)
-set(BUILD_SHARED_LIBS OFF CACHE BOOL "disable shared libraries") # Tells loki-mq to do a static build
-loki_add_subdirectory(../vendors/loki-mq loki-mq EXCLUDE_FROM_ALL)
 find_package(OpenSSL REQUIRED)
 
 find_package(Boost
@@ -51,7 +49,6 @@ target_link_libraries(httpserver_lib PUBLIC storage)
 target_link_libraries(httpserver_lib PUBLIC utils)
 target_link_libraries(httpserver_lib PUBLIC pow)
 target_link_libraries(httpserver_lib PUBLIC crypto)
-target_link_libraries(httpserver_lib PUBLIC lokimq::lokimq)
 
 set_property(TARGET httpserver_lib PROPERTY CXX_STANDARD 17)
 set_property(TARGET httpserver_lib PROPERTY CXX_STANDARD_REQUIRED TRUE)
@@ -75,19 +72,17 @@ set_property(TARGET httpserver PROPERTY CXX_STANDARD_REQUIRED TRUE)
 target_link_libraries(httpserver PRIVATE httpserver_lib)
 install(TARGETS httpserver DESTINATION bin)
 # Build Info
-execute_process(
-    COMMAND
-        git rev-parse --short HEAD
-    OUTPUT_VARIABLE
-        SHORT_HASH
-    OUTPUT_STRIP_TRAILING_WHITESPACE)
 string(TIMESTAMP BUILD_TIME UTC)
-message(STATUS "using git commit hash ${SHORT_HASH}")
 message(STATUS "using UTC build time ${BUILD_TIME}")
-target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_GIT_HASH_STRING="${SHORT_HASH}")
+target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_GIT_HASH_STRING="deb-${LOKISS_VERSION_TAG}")
 target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_BUILD_TIME="${BUILD_TIME}")
 
 find_package(PkgConfig QUIET)
+
+pkg_check_modules(LOKIMQ REQUIRED liblokimq>=1.2.0)
+target_link_libraries(httpserver PUBLIC ${LOKIMQ_LIBRARIES})
+target_include_directories(httpserver PUBLIC ${LOKIMQ_INCLUDE_DIRS}/lokimq)
+
 if(PKG_CONFIG_FOUND)
     pkg_check_modules(SYSTEMD libsystemd)
     # Default ENABLE_SYSTEMD to true if we found it
diff --git a/httpserver/dns_text_records.cpp b/httpserver/dns_text_records.cpp
index 89b643b..5a20b5c 100644
--- a/httpserver/dns_text_records.cpp
+++ b/httpserver/dns_text_records.cpp
@@ -1,5 +1,5 @@
 #include "dns_text_records.h"
-#include "../external/json.hpp"
+#include <nlohmann/json.hpp>
 #include "pow.hpp"
 #include "version.h"
 #include <netinet/in.h>
diff --git a/httpserver/http_connection.h b/httpserver/http_connection.h
index 24fccac..66e8515 100644
--- a/httpserver/http_connection.h
+++ b/httpserver/http_connection.h
@@ -6,7 +6,7 @@
 #include <memory>
 #include <optional>
 
-#include "../external/json.hpp"
+#include <nlohmann/json.hpp>
 #include <boost/asio.hpp>
 #include <boost/asio/ssl/stream.hpp>
 #include <boost/beast/core.hpp>
diff --git a/httpserver/lmq_server.cpp b/httpserver/lmq_server.cpp
index 74dfee3..c6bcd5f 100644
--- a/httpserver/lmq_server.cpp
+++ b/httpserver/lmq_server.cpp
@@ -11,6 +11,8 @@
 #include <lokimq/hex.h>
 #include <lokimq/lokimq.h>
 
+#include <nlohmann/json.hpp>
+
 #include <optional>
 
 namespace loki {
diff --git a/httpserver/request_handler.h b/httpserver/request_handler.h
index cfe559c..2af16ea 100644
--- a/httpserver/request_handler.h
+++ b/httpserver/request_handler.h
@@ -7,7 +7,7 @@
 #include <boost/asio.hpp>
 
 // TODO: can I avoid including this in the header?
-#include "../external/json.hpp"
+#include <nlohmann/json_fwd.hpp>
 
 // TODO: move ChannelEncryption to ::loki
 template <typename T>
diff --git a/httpserver/stats.cpp b/httpserver/stats.cpp
index c185585..ae1844c 100644
--- a/httpserver/stats.cpp
+++ b/httpserver/stats.cpp
@@ -1,5 +1,5 @@
 #include "stats.h"
-#include "../external/json.hpp"
+#include <nlohmann/json.hpp>
 #include <algorithm>
 #include <chrono>
 #include <iostream>
diff --git a/storage/CMakeLists.txt b/storage/CMakeLists.txt
index 75ac612..b29440d 100644
--- a/storage/CMakeLists.txt
+++ b/storage/CMakeLists.txt
@@ -18,8 +18,8 @@ loki_add_subdirectory(../common common)
 target_link_libraries(storage PRIVATE common)
 loki_add_subdirectory(../utils utils)
 target_link_libraries(storage PRIVATE utils)
-loki_add_subdirectory(../vendors/sqlite sqlite)
-target_link_libraries(storage PRIVATE sqlite)
+find_library(SQLITE3_LIBRARY sqlite3)
+target_link_libraries(storage PRIVATE ${SQLITE3_LIBRARY})
 
 
 if(NOT Boost_FOUND)
