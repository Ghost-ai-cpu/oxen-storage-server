From: Jason Rhinelander <jason@imaginary.ca>
Date: Tue, 16 Jul 2019 16:08:10 -0300
Subject: Devendor loki-storage-server

---
 CMakeLists.txt            |  5 +++--
 httpserver/CMakeLists.txt | 18 +++++-------------
 httpserver/lmq_server.cpp |  2 ++
 storage/CMakeLists.txt    |  4 ++--
 4 files changed, 12 insertions(+), 17 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 50dfbe7..6f54c3f 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -62,14 +62,15 @@ include(contrib/check_for_std_filesystem.cmake)
 
 find_package(Boost REQUIRED)
 
+pkg_check_modules(LOKIMQ REQUIRED IMPORTED_TARGET liblokimq>=1.2)
+add_library(lokimq::lokimq ALIAS PkgConfig::LOKIMQ)
+
 add_subdirectory(common)
 add_subdirectory(utils)
 add_subdirectory(crypto)
 add_subdirectory(pow)
 add_subdirectory(storage)
 add_subdirectory(httpserver)
-set(BUILD_SHARED_LIBS OFF CACHE BOOL "disable shared libraries") # Tells loki-mq to do a static build
-add_subdirectory(vendors/loki-mq)
 
 option(BUILD_TESTS "build storage server unit tests" OFF)
 if (BUILD_TESTS)
diff --git a/httpserver/CMakeLists.txt b/httpserver/CMakeLists.txt
index 604e695..95dbae2 100644
--- a/httpserver/CMakeLists.txt
+++ b/httpserver/CMakeLists.txt
@@ -38,7 +38,6 @@ target_link_libraries(httpserver_lib PUBLIC
     common storage utils pow crypto
     OpenSSL::SSL OpenSSL::Crypto
     nlohmann_json::nlohmann_json
-    lokimq::lokimq
     Boost::system Boost::program_options)
 
 # libresolv is needed on linux, but not on BSDs, so only link it if we can find it
@@ -55,25 +54,18 @@ set_target_properties(httpserver PROPERTIES OUTPUT_NAME ${BIN_NAME})
 target_link_libraries(httpserver PRIVATE httpserver_lib)
 install(TARGETS httpserver DESTINATION bin)
 # Build Info
-find_package(Git)
-if(GIT_FOUND)
-    execute_process(
-        COMMAND
-            git rev-parse --short HEAD
-        OUTPUT_VARIABLE
-            SHORT_HASH
-        OUTPUT_STRIP_TRAILING_WHITESPACE)
-else()
-    set(SHORT_HASH "unknown")
-endif()
+set(SHORT_HASH "deb-${OXENSS_VERSION_TAG}")
 string(TIMESTAMP BUILD_TIME UTC)
-message(STATUS "using git commit hash ${SHORT_HASH}")
 message(STATUS "using UTC build time ${BUILD_TIME}")
 configure_file("${CMAKE_CURRENT_SOURCE_DIR}/version.cpp.in" "${CMAKE_CURRENT_BINARY_DIR}/version.cpp")
 target_sources(httpserver_lib PRIVATE "${CMAKE_CURRENT_BINARY_DIR}/version.cpp")
 target_include_directories(httpserver_lib PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}")
 
 find_package(PkgConfig QUIET)
+
+pkg_check_modules(LOKIMQ REQUIRED IMPORTED_TARGET liblokimq>=1.2.0)
+target_link_libraries(httpserver PUBLIC PkgConfig::LOKIMQ)
+
 if(PKG_CONFIG_FOUND)
     pkg_check_modules(SYSTEMD libsystemd)
     # Default ENABLE_SYSTEMD to true if we found it
diff --git a/httpserver/lmq_server.cpp b/httpserver/lmq_server.cpp
index b564987..b40567d 100644
--- a/httpserver/lmq_server.cpp
+++ b/httpserver/lmq_server.cpp
@@ -11,6 +11,8 @@
 #include <lokimq/lokimq.h>
 #include <nlohmann/json.hpp>
 
+#include <nlohmann/json.hpp>
+
 #include <optional>
 
 namespace oxen {
diff --git a/storage/CMakeLists.txt b/storage/CMakeLists.txt
index 563c10d..e7bc336 100644
--- a/storage/CMakeLists.txt
+++ b/storage/CMakeLists.txt
@@ -10,7 +10,7 @@ target_include_directories(storage
 )
 
 target_link_libraries(storage PRIVATE common utils)
-add_subdirectory(../vendors/sqlite sqlite)
-target_link_libraries(storage PRIVATE sqlite)
+find_library(SQLITE3_LIBRARY sqlite3)
+target_link_libraries(storage PRIVATE ${SQLITE3_LIBRARY})
 
 target_link_libraries(storage PRIVATE Boost::boost)
