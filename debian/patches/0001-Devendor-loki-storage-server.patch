From: Jason Rhinelander <jason@imaginary.ca>
Date: Tue, 16 Jul 2019 16:08:10 -0300
Subject: Devendor loki-storage-server

---
 CMakeLists.txt            |  5 +++--
 common/CMakeLists.txt     |  2 +-
 httpserver/CMakeLists.txt | 16 +---------------
 3 files changed, 5 insertions(+), 18 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7f68de5..8b92d7e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -76,13 +76,14 @@ include(cmake/check_for_std_filesystem.cmake)
 if(NOT BUILD_STATIC_DEPS)
 endif()
 
+pkg_check_modules(OXENMQ REQUIRED IMPORTED_TARGET liboxenmq>=1.2.5)
+add_library(oxenmq::oxenmq ALIAS PkgConfig::OXENMQ)
+
 add_subdirectory(common)
 add_subdirectory(utils)
 add_subdirectory(crypto)
 add_subdirectory(storage)
 add_subdirectory(httpserver)
-set(BUILD_SHARED_LIBS OFF CACHE BOOL "disable shared libraries") # Tells loki-mq to do a static build
-add_subdirectory(vendors/loki-mq)
 
 if (BUILD_TESTS)
     add_subdirectory(unit_test)
diff --git a/common/CMakeLists.txt b/common/CMakeLists.txt
index 8c4cc90..ea24ba7 100644
--- a/common/CMakeLists.txt
+++ b/common/CMakeLists.txt
@@ -6,6 +6,6 @@ add_library(common STATIC
     src/oxen_logger.cpp
 )
 
-add_subdirectory(../vendors/spdlog spdlog)
+find_package(spdlog)
 target_link_libraries(common PUBLIC spdlog::spdlog filesystem oxenmq::oxenmq)
 target_include_directories(common PUBLIC ${CMAKE_CURRENT_LIST_DIR}/include)
diff --git a/httpserver/CMakeLists.txt b/httpserver/CMakeLists.txt
index 65a6d46..e78441e 100644
--- a/httpserver/CMakeLists.txt
+++ b/httpserver/CMakeLists.txt
@@ -22,16 +22,12 @@ add_library(httpserver_lib STATIC
     oxend_rpc.cpp
     )
 
-set(JSON_MultipleHeaders ON CACHE BOOL "") # Allows multi-header nlohmann use
-add_subdirectory(../vendors/nlohmann_json nlohmann_json)
-
 # TODO: enable more warnings!
 target_compile_options(httpserver_lib PRIVATE -Wall -Werror)
 
 target_link_libraries(httpserver_lib PUBLIC
     common storage utils crypto
     OpenSSL::SSL OpenSSL::Crypto
-    nlohmann_json::nlohmann_json
     oxenmq::oxenmq
     Boost::system Boost::program_options)
 
@@ -49,17 +45,7 @@ set_target_properties(httpserver PROPERTIES OUTPUT_NAME ${BIN_NAME})
 target_link_libraries(httpserver PRIVATE httpserver_lib)
 install(TARGETS httpserver DESTINATION bin)
 # Build Info
-find_package(Git)
-if(GIT_FOUND)
-    execute_process(
-        COMMAND
-            git rev-parse --short HEAD
-        OUTPUT_VARIABLE
-            SHORT_HASH
-        OUTPUT_STRIP_TRAILING_WHITESPACE)
-else()
-    set(SHORT_HASH "unknown")
-endif()
+set(SHORT_HASH "deb-${OXENSS_VERSION_TAG}")
 string(TIMESTAMP BUILD_TIME UTC)
 message(STATUS "using git commit hash ${SHORT_HASH}")
 message(STATUS "using UTC build time ${BUILD_TIME}")
